# Introduction #

This is a document by and for developers.

# Loose Ends #

## Code changes / Additional comments / questions ##

ColumnService -- not implemented -- is this obsolete?

DataServiceImpl.createOrUpdateRow, getRow, deleteRow
-- these will all fail in the af.checkFilter(dbRow) if the database row does not already exist (== null).  Should add guards for that and return a better exception.

DataManager.getRow(rowid) vs. getRowNullSafe(rowid).  You should implement the first the same as the second, but wrap the first in a try-catch block, catching the ODKEntityNotFound exception and returning null.

## Security Model ##

Can you write up a description of the security model?  And, from Friday's discussion, you'll be implementing a simple form of the GROUP functionality?

Seems like there is overall access to the table, governed by the permissions assigned to ( DEFAULT\_USER union "userid" union GROUPs to which "userid" is a member).
This right is one of ( READ, WRITE, DELETE ).

Then, for manipulating a row, you additionally need either:
- UNFILTERED\_ROWS assigned to ( DEFAULT\_USER union "userid" ) OR:
- the row stored in the database must have a **single** SCOPE attached to it and this SCOPE is of type USER, GROUP or DEFAULT.  If USER, the "userid" must match, if GROUP, the "userid" must be assigned to that group, or if DEFAULT, access is granted to all.

[i.e., you can't have read access to the overall table with write access to individual rows -- you have to have write access to the entire table, not be granted the UNFILTERED\_ROWS property and, then, to accomplish the equivalent restrictions, you would have the writable rows being granted a SCOPE to which you belong, and all the read-only rows lacking that scope].

## Data mode ##

I'd like to see a graphical description of the data model (e.g., odktables.relation.**) and any foreign key columns linking across those tables.  Perhaps that would be in your write-up?**

## Server issues to discuss in person ##

We should talk after you have a draft of the data model (at a minimum) and perhaps after the security model is described, if it doesn't work like I stated.

w.r.t. the data model, how would incomplete updates be handled?  I think we had you assume these don't happen?  I would like to talk to you in person about where the missing code would be to do this, and any thoughts you have in this regard.

Also, w.r.t. the data model, are there any filter conditions that are commonly applied to the static fields of these tables?  If so, they could benefit by defining an index on those columns ( using DataField.setIndexable(IndexType) ).  I'd like to talk to you in person about this (I would be doing this change, and the failure recovery changes myself).

## Client and Server ##

I see on the ODK Tables Android app that there are additional datatypes such as:

Date Range
Phone number
File
Collect Form
Multiple Choice
Join
Location

I didn't see any of these in the ODK Tables server code.  Are they not implemented, or did you handle them somewhere that I'm not seeing?

## Client w.r.t. Server ##
w.r.t. the Android client:

  * need documentation on how to generate the odk-tables-api-1.0.jar and javadoc from the aggregate sources.  I assume these aren't yet generated by maven?

  * need documentation on what libraries are required on client to use the interface proxy.

  * are there any test apps you're using that are not checked in anywhere?

## Client Sync Code (to discuss in person) ##

Looks like there is an assumption that the SyncTag does not need any HTML encoding.  What is the format of a SyncTag? Should be called out in documentation.

Looks like there is no way to delete a table property, only put (insert/update) one?

TablesContentProvider -- AUTHORITY references yoonsung... -- shouldn't this be changed?

Seems odd to have the database's table properties SyncState dictate the synchronization sequence.  I think it should always be in a fixed order (for reliable error recovery).  But perhaps I'm not understanding the sync logic.

If deletes trump updates, I've used this sequence in the past:

  * DELETE records on SERVER to reflect local deletions
  * DELETE local records to reflect server deletions
  * INSERT/UPDATE SERVER with un-conflicted new/changed local records
  * INSERT/UPDATE LOCAL with un-conflicted new/changed server records
  * DOWNLOAD SERVER records in conflict
  * Reconcile local

If deletes don't trump updates, then perhaps it doesn't matter???

Unclear what DB\_TRANSACTIONING is for, esp. on individual rows.



## Client ##

  * crash when trying to fill in table containing unusual data types (see above).  e.g., File.

  * crash when in Column Manager and click on a column of a table holding no data. Seems to be trying to remove an item from an immutable list???  After a few tries, it does work???

  * crash when deleting a column -- various array index out of bounds and SQLite no-such-column errors.  This prevents the table from being used.

  * in Column Manager -- it is difficult to choose the settings on a Droid (too small an area or too far to the right?).  This is a long click, but only over the settings icon, not over the whole column entry.

  * back button on table selection screen does not work (stays on main tables selection page.  Should allow return to Android Home Page.

  * no Image/Audio/Video file type.

## Questions for Hilary about ODK Tables ##

Here are a list of questions and clarifications I'd like for the ODK Tables code:

> (1) I'd like to see a database schema for ODK Tables, including at least a description of the items stored in the database and those stored outside the database(s) as Preferences.

**Presumably this will be part of your write-up?**

> (2) It looks like there are older classes in:

```
org.opendatakit.tables.Database
```
and newer clases in
```
org.opendatakit.tables.data
```
Which ones are used? Is there any reason not to delete the older ones?

e.g., how does the table: colProps (ColumnProperties) relate to the table: colProperty  (ColumnProperty)?

There are several other confusing sets of tables here -- I'm looking at DBIO and comparing the tables it creates to similar tables defined in org.opendatakit.tables.data

H: org.opendatakit.tables.data is the new package. The other stuff is left over from a refactor. I've deleted them.

> (3) It looks like all data columns are stored as TEXT values? (i.e., you can identify then as "Numeric" or "Date" or "Date Range" but they are stored as TEXT values in the database.

Is that true?

H: I've changed it to use the SQLite real type for number columns. SQLite stores dates in text fields anyway.

> (4) There are still some references involving yoonsung -- should these be changed?  If not, why not:
```
res\xml\syncadapter.xml  -- this still references yoonsung.odk.spreadsheet
TablesContentProvider (AUTHORITY)
FileManager ("/data/data/com.yoonsung.spreadsheetsms" ) 
```

H: I believe that is from Dylan's sync stuff.

> (5) Please add documentation to the following:
```
AbstractGraph.getTickSeparation
```
  * what are the aFactors[.md](.md) and bFactors[.md](.md) arrays for and what do they do?

H: I'll add documentation before I leave.

```
TouchViewListener.onInterceptTouchEvent 
TouchViewListener.onTouchEvent
```
  * what are the actions that these two methods each implement?
  * how do they interact and coordinate with each other?
  * what does a drag+fling to the right do?
  * would be useful to know both what gestures are doing and what the expectations are for the presence or null-valueness of the various
mDragListener, mDropListener, mRemoveListener objects are during
the touch action handling.
```
TouchViewListener.mTempRect 
```
    * seems like this should be a local variable, not an instance variable
    * are there any other variables in this object/class that are similarly transient and do not carry persistent values across method calls?

YoonSung did the TouchView stuff. I doubt I understand it any better than you.

> (6) What is the difference between the graph packages?
```
org.opendatakit.tables.Library.graphs 
org.opendatakit.tables.view.graphs
```
Seems like they both hold graphs, and some classes in Library.graphs inherit from AbstractChart.

H: Originally, the graphs were implemented with the AChartEngine library (this is the Library.graphs package). There were some things that were a little bit off though (tick marks not lined up well and stuff like that), so I had to override some major methods (like onDraw() or methods onDraw() called) to get the graphs to look right. This was pretty inconvenient and very messy, and I think it would have been more trouble than it was worth to maintain. So, the view.graphs package replaces Library.graphs with graph classes that don't use AChartEngine.
I've gotten rid of the old graphs.

In particular:

```
EXYChart
```
Looks like this and the AbstractChart should be refactored to consolidate some code. Thoughts?

I notice, in particular, that it might make sense to consolidate the simplistic single data -to- screen coordinate translation map maintained in AbstractChart with the multiple data series mappings of EXYChart.

```
CalendarView
```
  * what is W (e.g., in getW())?

H: IIRC, it gets the width that it will need to use (which can be called before the layout stuff Android does).

Do you have examples of the use of these:
  * CalendarDayView,
  * CalendarWeekView.
Or even just screen shots.

H: I'll see if I can dig some up. Or I'll implement activities for them that follow the new pattern.

```
GValuePercentilePoint vs. PercentileSeries
```
in some places there is an object for a single data point (GValuePercentilePoint, GValueYPoint, GXYPoint), and elsewhere there is no abstraction, but a set of arrays (PercentileSeries) -- why is this?

I would assume abstracting everything to data points makes sense here.  Or does org.achartengine.model work better when things are structured the other way? Thoughts?

> (7) EGraphicalView -- why is this only for EXYChart and not for other AbstractChart subtypes?

> (8) GraphFactory and all the activities in:
```
 org.opendatakit.tables.Activity.graphs
 org.opendatakit.tables.activities
```

It seems that there is both a BoxStemActivity and a BoxStemGraphActivity
and also a MapDisplayActivity and a MapViewActivity,
and others. Which ones are used, are there any that should be deleted.

If they should be deleted, is there anything of value in the ones to be deleted that should be remembered or integrated in the ones now being used?

> (9) GraphFactory isn't really used as a factory.  It looks like the activities are tightly coupled with the views they instantiate.
Also, it looks like some views are not used???  e.g., scatter graphs?

> (10) MapViewActivity -- this is using JSON objects for the geopoints.

Why was this decision made?

H: Is this the old one or the new MapDisplayActivity? I think YoonSung did the old maps, but MapDisplayActivity is the one in use.

Also, why are you multiplying the lat/long values by 1e+06 ?  Seems like the geopoint values should remain at the expected scale, and any scaling should be done as the values are rendered, not before.

H: fixed.

> (11) When you are showing a graph view, and choose to change the type of graph (e.g., line vs. point), from within the menu choices for that graph view, it looks like you need to exit that view and  re-enter it to have it pick up the change? (just a question, based upon the code I see).

H: Yeah, the old graphs did that. The new ones don't.

> (12) There are quite a few activities that appear to be dead code (e.g., FileManager)

Can you list the activities that are currently used, and any that should be kept but updated for future uses?  And delete any activities that are obsolete?

H: I've deleted a bunch at this point, and I'll get rid of anything else before I leave.

e.g., ShortcutsManager  -- looks like this was hardcoded with "... fish..." for a demo.  And is apparently kept as an exemplar for what would need to be done to set up a shortcut???

H: I'll look into that. I don't think ShortcutsManager is actually in use.

> (13) The CSV Import is run in a background thread, but not an AsyncTask, and the CSV Export is run in the UI thread (at least, I don't see any threading in that code). I assume this is Yoonsung's
code? And I haven't missed any task-based versions of this anywhere, correct?

H: It's my code, and no, you haven't missed a task version of it.
Exporting should be the same way as importing, although that wasn't a high priority because exporting is faster than importing (although you'd probably run into problems with large tables).

> (14) I'm confused by the code in MainDisplaySettings.spinnerTexts and LanguageUtils.getViewTypeLabel -- I assume the LanguageUtils versions of these strings should be used, and not the spinnerTexts, or at least that they should contain the same set of values?

H: Yeah LanguageUtils should probably be used.

> (15) Do you know anything about the org.opendatakit.tables.Database.DataUtils (Date and DateRange utility functions)?  How do these relate to the org.opendatakit.tables.data.DataUtil class that seems to do those things and more?

Would be nice to have an explanation of what the intended capabilities of these classes are (e.g., what date formats, etc. are supported, esp. w.r.t. "now").  And can one of them be deleted?  What needs to be kept?

H: Database.DataUtils has been deleted. I'll write up the formats and send it to.

> (16) This appears to be unused:
```
org.opendatakit.tables.Database.SecurityTables
```
What implements access security now?

I should note, if it wasn't obvious, that that security stuff involved SMS access, not Aggregate. And it's done in MsgHandler (in the SMS package).

## Collect tie-in ##

Missing features in ODK Collect for handling data types in ODK Tables

  * Generic File Selection widget

  * date range widget